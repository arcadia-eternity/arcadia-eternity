name: Release Please

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: write
  id-token: write
  issues: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      upload_url: ${{ steps.release.outputs.upload_url }}
    steps:
      - name: Run release-please
        uses: googleapis/release-please-action@v4
        id: release
        with:
          # è‡ªå®šä¹‰é…ç½®
          config-file: .github/release-please-config.json
          manifest-file: .release-please-manifest.json

  # å½“åˆ›å»ºreleaseæ—¶ï¼Œè‡ªåŠ¨åˆå¹¶åˆ°productionåˆ†æ”¯
  merge-to-production:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create or update production branch
        run: |
          # æ£€æŸ¥productionåˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git show-ref --verify --quiet refs/remotes/origin/production; then
            echo "Production branch exists, checking out..."
            git checkout production
            git pull origin production
          else
            echo "Creating production branch..."
            git checkout -b production
          fi

      - name: Merge main to production
        run: |
          echo "Merging main to production for release ${{ needs.release-please.outputs.tag_name }}"
          git merge origin/main --no-ff -m "chore: merge main to production for release ${{ needs.release-please.outputs.tag_name }}"

      - name: Push production branch
        run: |
          git push origin production

      - name: Trigger production workflows
        uses: actions/github-script@v7
        with:
          script: |
            // è§¦å‘ç”Ÿäº§é•œåƒæ„å»º
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-production-image.yml',
              ref: 'production',
              inputs: {
                version: '${{ needs.release-please.outputs.version }}'
              }
            });

            // è§¦å‘Tauriæ„å»º
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'release.yaml',
              ref: 'production',
              inputs: {
                version: '${{ needs.release-please.outputs.tag_name }}'
              }
            });

            console.log('Triggered production workflows for version ${{ needs.release-please.outputs.tag_name }}');

      - name: Create production deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.payload.pull_request?.number || 1,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸš€ **Production Deployment Triggered**
              
              Release \`${{ needs.release-please.outputs.tag_name }}\` has been created and merged to production branch.
              
              **Deployment Status:**
              - âœ… Production branch updated
              - ğŸ”„ Cloudflare Pages deployment in progress
              - ğŸ”„ Server deployment in progress
              - ğŸ”„ Tauri build in progress
              
              **Links:**
              - [Release Notes](https://github.com/${{ github.repository }}/releases/tag/${{ needs.release-please.outputs.tag_name }})
              - [Production Site](https://yourdomain.com) (will update shortly)
              `
            });
