name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      upload_url: ${{ steps.release.outputs.upload_url }}
    steps:
      - name: Run release-please
        uses: google-github-actions/release-please-action@v4
        id: release
        with:
          release-type: node
          package-name: arcadia-eternity
          # è‡ªå®šä¹‰é…ç½®
          config-file: .github/release-please-config.json
          manifest-file: .github/.release-please-manifest.json

  # å½“åˆ›å»ºreleaseæ—¶ï¼Œè‡ªåŠ¨åˆå¹¶åˆ°productionåˆ†æ”¯
  merge-to-production:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create or update production branch
        run: |
          # æ£€æŸ¥productionåˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git show-ref --verify --quiet refs/remotes/origin/production; then
            echo "Production branch exists, checking out..."
            git checkout production
            git pull origin production
          else
            echo "Creating production branch..."
            git checkout -b production
          fi

      - name: Merge main to production
        run: |
          echo "Merging main to production for release ${{ needs.release-please.outputs.tag_name }}"
          git merge origin/main --no-ff -m "chore: merge main to production for release ${{ needs.release-please.outputs.tag_name }}"

      - name: Push production branch
        run: |
          git push origin production

      - name: Create production deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.payload.pull_request?.number || 1,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸš€ **Production Deployment Triggered**
              
              Release \`${{ needs.release-please.outputs.tag_name }}\` has been created and merged to production branch.
              
              **Deployment Status:**
              - âœ… Production branch updated
              - ğŸ”„ Cloudflare Pages deployment in progress
              - ğŸ”„ Server deployment in progress
              - ğŸ”„ Tauri build in progress
              
              **Links:**
              - [Release Notes](https://github.com/${{ github.repository }}/releases/tag/${{ needs.release-please.outputs.tag_name }})
              - [Production Site](https://yourdomain.com) (will update shortly)
              `
            });

  # æ„å»ºç”Ÿäº§ç¯å¢ƒDockeré•œåƒ
  build-production-image:
    needs: [release-please, merge-to-production]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.release-please.outputs.tag_name }}

      - name: Log into GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=production
            type=raw,value=${{ needs.release-please.outputs.tag_name }}
            type=raw,value=latest

      - name: Build and push production Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NODE_ENV=production
            VERSION=${{ needs.release-please.outputs.version }}
            GITHUB_SHA=${{ github.sha }}
            COMMIT_HASH=${{ github.sha }}
