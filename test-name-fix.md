# 玩家改名逻辑修复测试

## 修复内容

### 1. 服务器端修复

#### 新增API端点
- **PUT /api/v1/auth/update-player-name**: 更新玩家名字的专用API端点
- 支持游客和注册用户
- 使用智能认证中间件

#### 修改 ensurePlayer 方法
- 不再覆盖已存在玩家的名字
- 只在玩家不存在时创建新玩家
- 已存在的玩家只更新登录时间

### 2. 客户端修复

#### 修改 setName() 方法
- 先保存到本地存储
- 异步同步到服务器
- 即使服务器同步失败，本地修改也会保留

#### 修改 initializePlayer() 方法
- 优先使用本地名字
- 只有在本地没有名字时才使用服务器的名字

## 测试步骤

### 测试场景1：游客用户改名
1. 打开应用，确保是游客模式
2. 进入账户页面，修改玩家名字
3. 刷新页面，验证名字是否保持修改后的状态

### 测试场景2：注册用户改名
1. 绑定邮箱成为注册用户
2. 修改玩家名字
3. 刷新页面，验证名字是否保持修改后的状态

### 测试场景3：离线模式改名
1. 断开网络连接
2. 修改玩家名字
3. 重新连接网络并刷新页面
4. 验证名字是否保持修改后的状态

## 预期结果

- 所有场景下，玩家改名后刷新页面都不会被服务器的旧名字覆盖
- 本地存储的名字优先级高于服务器返回的名字
- 名字修改会异步同步到服务器（如果可能）

## 技术细节

### API调用流程
1. 用户修改名字 → `setName()` 方法
2. 立即保存到本地存储
3. 异步调用 `/api/v1/auth/update-player-name` API
4. 服务器更新数据库中的玩家名字

### 刷新页面流程
1. 页面加载 → `initializePlayer()` 方法
2. 检查服务器上的玩家状态
3. 优先使用本地存储的名字
4. 只有在本地没有名字时才使用服务器的名字

### 错误处理
- 服务器同步失败不影响本地修改
- 网络错误时仍然保持本地修改
- 服务器返回错误时记录日志但不显示给用户
