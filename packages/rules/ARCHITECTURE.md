# 规则系统架构文档

## 概述

规则系统框架是一个灵活、可扩展的游戏规则管理系统，支持各种游戏模式的规则定义、验证和应用。

## 核心架构

### 1. 接口层 (interfaces/)

#### Rule 接口

- 定义了规则的基本结构和行为
- 支持队伍、精灵、技能、印记的验证和修改
- 提供战斗配置和计时器配置的修改能力
- 支持额外内容的注入

#### RuleSet 接口

- 规则的集合，代表特定的游戏模式
- 管理规则的添加、移除和启用/禁用
- 提供规则集级别的验证功能

#### ValidationResult 类型

- 统一的验证结果格式
- 包含错误、警告和验证状态
- 提供构建器模式简化结果创建

### 2. 核心层 (core/)

#### RuleRegistry

- 单例模式的规则注册表
- 管理所有规则和规则集的注册、查找
- 支持依赖关系管理
- 提供完整性验证

#### RuleSystem

- 规则系统的主要入口点
- 管理规则集的激活和应用
- 协调多个规则的执行
- 提供统一的验证和修改接口

#### AbstractRule & AbstractRuleSet

- 提供规则和规则集的基础实现
- 简化自定义规则的开发
- 包含常用的辅助方法

### 3. 规则实现层 (rules/)

#### 基础规则 (basic/)

- **TeamSizeRule**: 队伍大小限制
- **LevelLimitRule**: 精灵等级限制
- **BanRule**: 禁用特定内容

#### 竞技规则 (competitive/)

- **EVLimitRule**: 学习力限制
- **TimerRule**: 计时器配置

#### 特殊规则 (special/)

- **ElementRestrictionRule**: 属性限制

### 4. 预定义规则集 (rulesets/)

#### 可用规则集

- `casual_standard_ruleset`: 休闲标准规则，适合日常对战
- `competitive_ruleset`: 竞技规则，严格的竞技对战规则集

### 5. 系统集成层 (integration/)

#### BattleIntegration

- 与战斗系统的集成
- 战斗准备时的规则验证和应用
- 战斗过程中的操作验证

#### TimerIntegration

- 与计时器系统的集成
- 计时器配置的规则修改
- 配置兼容性检查

#### TeamBuilderIntegration

- 与队伍构建器的集成
- 实时队伍验证
- 构建建议和自动修复

## 数据流

```
用户操作 → 规则系统 → 规则集 → 具体规则 → 验证/修改 → 结果反馈
```

### 验证流程

1. 用户触发验证（队伍构建、战斗准备等）
2. 规则系统获取激活的规则集
3. 按优先级执行所有适用的规则
4. 收集验证结果并合并
5. 返回统一的验证结果

### 修改流程

1. 验证通过后应用规则修改
2. 按优先级顺序执行修改
3. 修改精灵、技能、印记数据
4. 应用战斗和计时器配置修改

## 扩展机制

### 自定义规则

```typescript
class CustomRule extends AbstractRule {
  validateTeam(team: Team): ValidationResult {
    // 实现验证逻辑
  }
  
  modifyPet(pet: PetSchemaType): void {
    // 实现修改逻辑
  }
}
```

### 自定义规则集

```typescript
const customRuleSet = new RuleSetImpl('custom', '自定义规则集')
customRuleSet.addRule(new CustomRule())
registry.registerRuleSet(customRuleSet)
```

## 性能考虑

### 规则缓存

- 规则按优先级排序后缓存
- 避免重复的规则查找和排序

### 延迟验证

- 支持按需验证，避免不必要的计算
- 规则适用性检查减少无效规则执行

### 批量操作

- 支持批量验证和修改
- 减少系统调用开销

## 错误处理

### 验证错误

- 详细的错误信息和上下文
- 错误分类和错误代码
- 修复建议

### 系统错误

- 规则注册失败处理
- 依赖关系冲突检测
- 优雅的降级机制

## 测试策略

### 单元测试

- 每个规则的独立测试
- 规则集组合测试
- 边界条件测试

### 集成测试

- 与其他系统的集成测试
- 完整工作流测试
- 性能测试

## 未来扩展

### 动态规则

- 运行时规则修改
- 条件触发规则
- 事件驱动规则

### 规则编辑器

- 可视化规则编辑
- 规则模板系统
- 规则导入导出

### 高级功能

- 规则版本管理
- 规则回滚机制
- 规则统计分析
