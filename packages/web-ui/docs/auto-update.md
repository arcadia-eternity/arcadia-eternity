# 自动更新检查功能

## 概述

客户端模式现在支持在应用启动时自动检查更新。这个功能只在 Tauri 桌面版的生产环境下运行，确保用户能够及时获得最新版本的应用。

## 功能特性

### 自动检查条件

- **仅 Tauri 环境**: 只在桌面客户端中运行，Web 版本不支持
- **仅生产环境**: 开发环境下会跳过自动检查，避免干扰开发工作
- **延迟启动**: 应用启动后延迟 3 秒再检查更新，避免与其他初始化操作冲突

### 用户体验

1. **静默检查**: 自动检查过程在后台进行，不会阻塞应用启动
2. **友好通知**: 如果发现新版本，会显示一个不自动关闭的通知
3. **用户选择**: 用户可以选择立即更新或稍后更新
4. **自动重启**: 更新完成后会自动重启应用

### 错误处理

- 检查失败时不会显示错误消息，避免打扰用户
- 所有错误都会记录到控制台，便于调试

## 技术实现

### 核心函数

```typescript
// packages/web-ui/src/utils/version.ts
export async function autoCheckForUpdates(): Promise<void>
```

### 调用位置

```typescript
// packages/web-ui/src/App.vue
onMounted(async () => {
  // ... 其他初始化代码

  // 在应用初始化完成后，延迟一段时间再检查更新
  setTimeout(() => {
    autoCheckForUpdates()
  }, 3000) // 延迟3秒后检查更新
})
```

### 更新配置

更新检查使用 Tauri 的 updater 插件，配置在 `tauri.conf.json` 中：

```json
{
  "plugins": {
    "updater": {
      "pubkey": "...",
      "endpoints": [
        "https://cdn.jsdelivr.net/gh/arcadia-eternity/arcadia-eternity/releases/latest/latest.json",
        "https://github.com/arcadia-eternity/arcadia-eternity/releases/latest/download/latest.json"
      ]
    }
  }
}
```

## 测试

### 开发环境测试

在开发环境下可以访问 `/update-test` 页面来测试自动更新功能：

1. 启动开发服务器: `pnpm dev:tauri`
2. 访问 `http://localhost:5173/update-test`
3. 查看环境检查结果
4. 手动触发更新检查测试

### 生产环境验证

1. 构建生产版本: `pnpm build:tauri`
2. 启动 Tauri 应用
3. 观察应用启动后 3 秒是否自动检查更新
4. 检查控制台日志确认功能正常运行

## 日志输出

### 正常流程

```
正在自动检查更新...
当前已是最新版本
```

或

```
正在自动检查更新...
发现新版本: 1.4.0
```

### 跳过检查

```
开发环境下跳过自动更新检查
```

### 错误情况

```
自动检查更新失败: [错误详情]
```

## 与手动更新的区别

| 特性 | 自动更新检查 | 手动更新检查 |
|------|-------------|-------------|
| 触发方式 | 应用启动时自动 | 用户点击按钮 |
| 环境限制 | 仅生产环境 | 所有环境 |
| 错误提示 | 静默处理 | 显示错误消息 |
| 通知方式 | 系统通知 | 消息提示 |

## 注意事项

1. **网络依赖**: 更新检查需要网络连接，离线环境下会失败
2. **权限要求**: 更新安装可能需要管理员权限
3. **防火墙**: 某些企业防火墙可能阻止访问 GitHub 更新端点
4. **存储空间**: 更新下载需要足够的磁盘空间

## 故障排除

### 更新检查失败

1. 检查网络连接
2. 确认防火墙设置
3. 查看控制台错误日志
4. 尝试手动检查更新

### 更新下载失败

1. 检查磁盘空间
2. 确认网络稳定性
3. 重试更新操作

### 更新安装失败

1. 确认应用权限
2. 关闭杀毒软件临时保护
3. 以管理员身份运行应用
