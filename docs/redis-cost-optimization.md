# Redis 成本优化方案

本文档详细说明了为降低 Upstash Redis 命令数量而实施的各项优化措施。

## 🎯 优化目标

- 减少 Redis 命令执行频率
- 降低 Upstash 使用成本
- 保持系统功能完整性
- 提高系统性能

## 📊 优化措施概览

### 1. 监控频率优化

**原始频率 → 优化后频率**
- 监控数据收集：30-60秒 → 2-5分钟
- 系统指标收集：30秒 → 5分钟
- 告警检查：60秒 → 60秒（保持不变）

**影响的 Redis 命令：**
- `INFO` - 减少 80-90%
- `INFO keyspace` - 减少 80-90%
- `SCAN` - 减少 80-90%

### 2. 心跳和健康检查优化

**原始频率 → 优化后频率**
- 集群心跳：30-45秒 → 2-5分钟
- 健康检查：60秒 → 10分钟
- 服务发现健康检查：30秒 → 5分钟
- 故障转移检查：60秒 → 10分钟

**影响的 Redis 命令：**
- `PING` - 减少 85-90%
- `HSET` (实例状态更新) - 减少 85-90%

### 3. 本地缓存层

**新增缓存机制：**
- Redis 统计信息缓存：2分钟 TTL
- 键统计缓存：5分钟 TTL
- 集群统计缓存：1分钟 TTL
- 玩家连接缓存：30秒 TTL
- Redis INFO 缓存：30秒 TTL

**影响的 Redis 命令：**
- 重复的 `INFO` 查询 - 减少 90%+
- 重复的 `SCAN` 操作 - 减少 90%+

### 4. SCAN 操作优化

**优化措施：**
- 增大 COUNT 参数：100 → 500
- 限制最大扫描次数：无限制 → 10次
- 减少扫描模式：8个 → 3个关键模式
- 启用模式缓存

**影响的 Redis 命令：**
- `SCAN` 命令数量减少 70-80%

### 5. 批量操作优化

**已实现的批量操作：**
- 实例信息批量获取 (Pipeline)
- 房间状态批量获取 (Pipeline)
- Token 黑名单批量检查 (Pipeline)
- 玩家连接批量查询 (Pipeline)

**影响的 Redis 命令：**
- 减少网络往返次数 50-70%

## 🔧 配置管理

### 环境变量配置

创建 `.env.cost-optimization` 文件：

```bash
# 启用成本优化
REDIS_COST_OPTIMIZATION=true

# 监控频率（秒）
MONITORING_METRICS_INTERVAL_DEV=120
MONITORING_METRICS_INTERVAL_PROD=300

# 心跳频率（秒）
CLUSTER_HEARTBEAT_INTERVAL_DEV=120
CLUSTER_HEARTBEAT_INTERVAL_PROD=300

# 健康检查频率（秒）
CLUSTER_HEALTH_CHECK_INTERVAL=600

# 缓存TTL（毫秒）
REDIS_STATS_CACHE_TTL=120000
KEY_STATS_CACHE_TTL=300000

# SCAN优化
REDIS_SCAN_COUNT=500
REDIS_SCAN_MAX_ITERATIONS=10
```

### 代码配置

使用 `costOptimizationConfig.ts` 统一管理所有优化配置。

## 📈 预期效果

### 命令数量减少估算

**每小时 Redis 命令数量对比：**

| 操作类型 | 优化前 | 优化后 | 减少比例 |
|---------|--------|--------|----------|
| 监控数据收集 | 120次 | 12-24次 | 80-90% |
| 心跳检查 | 80-120次 | 12-20次 | 85-90% |
| 健康检查 | 60次 | 6次 | 90% |
| SCAN 操作 | 480次 | 48-96次 | 80-90% |
| INFO 查询 | 240次 | 24-48次 | 80-90% |

**总体预期减少：80-85%**

### 成本节约估算

假设原始每小时执行 1000 个 Redis 命令：
- 优化前：1000 命令/小时 × 24小时 × 30天 = 720,000 命令/月
- 优化后：150-200 命令/小时 × 24小时 × 30天 = 108,000-144,000 命令/月
- **节约：75-85% 的命令数量**

## ⚠️ 注意事项

### 1. 监控延迟

- 问题检测延迟增加：从30秒-1分钟 → 2-10分钟
- 建议：关键告警保持较短检查间隔

### 2. 故障恢复时间

- 实例故障检测延迟：从1-2分钟 → 5-10分钟
- 建议：配置外部监控作为补充

### 3. 缓存一致性

- 统计数据可能有延迟
- 建议：重要操作前清除相关缓存

## 🚀 部署建议

### 1. 渐进式部署

1. 先在开发环境测试
2. 在生产环境启用部分优化
3. 监控系统稳定性
4. 逐步启用所有优化

### 2. 监控指标

关注以下指标：
- Redis 命令执行数量
- 系统响应时间
- 错误率变化
- 缓存命中率

### 3. 回滚方案

设置环境变量快速回滚：
```bash
REDIS_COST_OPTIMIZATION=false
```

## 📝 维护建议

1. **定期检查缓存效果**：监控缓存命中率
2. **调整缓存TTL**：根据实际使用情况优化
3. **监控系统健康**：确保优化不影响核心功能
4. **成本跟踪**：定期检查 Upstash 使用量和费用

## 🔍 故障排查

### 常见问题

1. **监控数据延迟**
   - 检查缓存TTL设置
   - 确认优化配置是否过于激进

2. **系统响应变慢**
   - 检查缓存内存使用
   - 调整批量操作大小

3. **数据不一致**
   - 清除相关缓存
   - 检查缓存失效逻辑

### 调试命令

```bash
# 检查当前配置
node -e "console.log(require('./src/cluster/costOptimizationConfig').getCostOptimizationConfig())"

# 清除所有缓存
# 重启服务即可
```
